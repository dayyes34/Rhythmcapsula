<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Календарь Telegram бронирование с корректными скидками</title>
  <style>
    body{font-family:Arial;margin-bottom:140px;}
    .slot{display:inline-block;width:72px;padding:3px;margin:2px;border:1px solid #aaa;border-radius:4px;cursor:pointer;text-align:center;}
    .booked{background:#eee;cursor:not-allowed;color:#999;}
    .selected{background:#039;color:#fff;}
    .old-price{color:#a00;text-decoration:line-through;margin-right:5px;}
    .final-price{color:green;font-weight:bold;}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<div id="calendar"></div>

<div style="position:fixed;bottom:0;background:#ddd;width:100%;padding:8px;">
  <button id="minusHour">-</button>
  <span id="hCount">3</span> ч
  <button id="plusHour">+</button>

  <div id="summary">Ничего не выбрано</div>
  <button onclick="bookSlots()">Забронировать выбранное</button>
</div>

<script>
Telegram.WebApp.expand();

const MSK_OFFSET=180,openHour=7,closeHour=23,daysShow=28;
let selD=null,selH=null,selL=3,final_price=0;
let BOOKED={};

fetch("https://drumfitness.ru/api/bookedslots")
.then(res=>res.json())
.then(data=>{
    BOOKED=data;
    render();
})
.catch(err=>{
    console.error(err);
    alert("Ошибка загрузки расписания");
});

function free(d,h){
    if(!BOOKED[d])return true;
    return !BOOKED[d].includes(`${h}:00`);
}

function mskDd(d){
    return new Date(d.getTime()+6e4*(MSK_OFFSET-d.getTimezoneOffset())).toISOString().slice(0,10);
}

function render(){
  let d=new Date(),html='';
  for(let i=0;i<daysShow;i++){
    let km = new Date(d.getTime()+6e4*(MSK_OFFSET-d.getTimezoneOffset()));
    let sd = mskDd(km);
    html+=`<div><b>${km.toLocaleDateString('ru',{weekday:'long',day:'numeric',month:'short'})}</b><br>`;
    for(let h=openHour;h<closeHour;h++){
      let b= !free(sd,h) ?'booked':'';
      html+=`<div class="slot ${b}" data-d="${sd}" data-h="${h}">${h}:00</div>`;
      if(h==openHour+14)html+="<br>";
    }
    html+="</div><hr>";
    d.setDate(d.getDate()+1);
  }
  document.getElementById('calendar').innerHTML=html;

  document.querySelectorAll('.slot:not(.booked)').forEach(e=>e.onclick=()=>choose(e.dataset.d,+e.dataset.h));
}

function choose(d,h){
  selD=d;selH=h;selL=getInitialL(d,h);upd();
}

function bookSlots(){
  if(selD==null||selH==null||selL<1){
    alert("Выбери слот для бронирования");
    return;
  }
  const user = Telegram.WebApp.initDataUnsafe.user || {};
  const username = user.username || "unknown";
  const customer = `${user.first_name || "Клиент"} ${user.last_name||""}`.trim();
  const telegramId = user.id;

  const hours=Array.from({length:selL},(_,i)=>`${selH+i}:00`);

  fetch("https://drumfitness.ru/api/bookings", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({date:selD,hours,customer,telegramId,username,totalprice:final_price})
  })
  .then(res=>res.json())
  .then(res=>{
    if(res.status=="OK"){
      alert("Забронировано успешно! Администрация скоро подтвердит заявку.");
      location.reload();
    }else{
      alert("Ошибка бронирования, попробуйте позже.");
    }
  })
  .catch(err=>{
    console.error(err);
    alert("Ошибка связи с сервером, повторите позже.");
  });
}

function getInitialL(d,h){
  if(free(d,h+1)&&free(d,h+2))return 3;
  if(free(d,h+1))return 2;
  if((!free(d,h-1)&&!free(d,h+1))||(h==closeHour-1&&!free(d,h-1)))return 1;
  return 0;
}

function canBookOne(d,h){
  return(!free(d,h-1)&&!free(d,h+1))||(h==closeHour-1&&!free(d,h-1));
}

function upd(){
  document.querySelectorAll('.slot').forEach(e=>e.classList.remove('selected'));
  if(selL<1){selD=null;selH=null;selL=0;document.getElementById('summary').innerHTML='Неверный выбор';return;}
  let total=0,full=0,basePrices=[];
  for(let h=selH;h<selH+selL;h++){
    document.querySelector(`.slot[data-d='${selD}'][data-h='${h}']`).classList.add('selected');
    let basePrice=selL==1?400:(selL==2?300:(h-selH<2?300:250));
    basePrices.push(basePrice);
  }
  full=basePrices.reduce((a,b)=>a+b,0);

  basePrices.forEach((hourPrice,i)=>{
    let curHour=selH+i,discount=0;
    if(curHour>=7&&curHour<11)discount=0.3;
    else if(curHour>=11&&curHour<14)discount=0.1;
    total+=hourPrice*(1-discount);
  });
  final_price=Math.round(total);
  document.getElementById('hCount').innerText=selL;
  document.getElementById('summary').innerHTML=`Выбрано ${selD} с ${selH}:00 до ${selH+selL}:00 (${final_price}₽)`;
}

document.getElementById('minusHour').onclick=()=>{
  if(selL>3||(selL==3&&free(selD,selH+1))||(selL==2&&canBookOne(selD,selH))){selL--;upd();}
  else{alert('Нельзя уменьшить меньше минимума');}
};

document.getElementById('plusHour').onclick=()=>{
  if(free(selD,selH+selL)){selL++;upd();}
  else{alert('Час занят или конец дня');}
};
</script>

</body>
</html>
