<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"><title>Календарь Telegram бронирование с корректными скидками</title>
    <style>
        body{
    margin:0;
    padding:0;
    font-family:'Arial',sans-serif;
    background:#000;
    color:#fff;
    user-select:none;
    display:flex;
    flex-direction:column;
    align-items:center;
}

#logo{
    width:100%;
    text-align:center;
    padding-top:15px;
    padding-bottom:5px;
}

#logo img{
    max-width:180px;
}

#calendar{
    padding:15px 10px 180px;
    width:100%;
    max-width:400px;
    text-align:center;
    box-sizing:border-box;
}

.slot{
    display:inline-block;
    width:65px;
    padding:6px;
    margin:3px;
    border-radius:8px;
    cursor:pointer;
    background:#111;
    color:#ddd;
    text-align:center;
    transition:.2s ease;
}

.slot.booked{
    background:#222;
    color:#555;
    cursor:not-allowed;
}

.slot.selected{
    background:#0ff;
    color:#000;
    box-shadow:0 0 12px #0ff;
}

.neon-btn{
    padding:15px 25px;
    background:#000;
    color:#00f7ff;
    font-weight:bold;
    font-size:16px;
    border-radius:12px;
    cursor:pointer;
    border:2px solid #00f7ff;
    box-shadow:0 0 15px #00f7ff, inset 0 0 5px rgba(0,247,255,0.5);
    transition:0.3s ease;
}

.neon-btn:hover,
.neon-btn:active{
    background:#00f7ff;
    color:#000;
    box-shadow:0 0 25px #00f7ff, inset 0 0 10px rgba(255,255,255,0.6);
}

#bottom{
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    padding:10px 0;
    background:#000;
    box-shadow:0 -3px 15px rgba(0,247,255,0.3);
    border-top:2px solid #00f7ff;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    box-sizing:border-box;
}

button.small-btn{
    background:#000;
    border:2px solid #00f7ff;
    border-radius:50%;
    width:50px;
    height:50px;
    cursor:pointer;
    box-shadow:0 0 15px #00f7ff, inset 0 0 5px rgba(0,247,255,0.4);
    color:#00f7ff;
    font-size:20px;
    transition:.3s ease;
    margin:6px;
}

button.small-btn:hover,
button.small-btn:active{
    background:#00f7ff;
    color:#000;
    box-shadow:0 0 25px #00f7ff,inset 0 0 10px rgba(255,255,255,0.6);
}

#summary{
    margin:10px 0;
    font-size:15px;
    padding: 0 10px;
}

.old-price{
    color:#a00;
    text-decoration:line-through;
    margin-right:5px;
}

.final-price{
    color:#0f0;
    font-weight:bold;
}

#calendar hr{
    border:none;
    margin:20px auto;
    height:3px;
    width:80%;
    max-width:300px;
    background:#00f7ff;
    box-shadow:0 0 12px #00f7ff,0 0 6px #fff inset;
    border-radius:20px;
    filter:blur(1px);
}

/* важное дополнение: кнопки занимают всю ширину на мобильных */
@media(max-width:480px){
    body,html{
        overflow-x:hidden;
        touch-action:manipulation;
    }

    #bottom{
        padding:15px 0;
    }

    .neon-btn{
        width:calc(100% - 20px);
        max-width:calc(100% - 20px);
        box-sizing:border-box;
        margin:8px 10px;
    }

    button.small-btn{
        flex:1;
        height:50px;
        border-radius:8px;
        width:auto;
        max-width:calc(50% - 20px);
        font-size:18px;
        margin:8px 10px;
    }

    #summary{
        margin:10px 0;
        padding:0 10px;
    }

    #bottom .btn-group-small{
        width:100%;
        display:flex;
        justify-content:center;
        padding:5px 0;
    }
}
</style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div id="calendar"></div>
<div style="position:fixed;bottom:0;background:#ddd;width:100%;padding:8px;">
    <button id="minusHour">➖</button>
    <span id="hCount">3</span> ч.
    <button id="plusHour">➕</button>
    <div id="summary">Ничего не выбрано</div>
    <button onclick="bookSlots()">Забронировать выбранное</button>
</div>

<script>
Telegram.WebApp.expand();
const MSK_OFFSET=180, openHour=7, closeHour=23,daysShow=28;
let selD=null,selH=null,selL=3;
let final_price = 0; //Итоговая цена бронирования

let BOOKED={}; 

fetch('https://drumfitness.ru/api/booked-slots')
  .then(res => res.json())
  .then(data => {
      BOOKED = data; // твой новый API УЖЕ дает формат как раз {дата:[часы,...]}
      render();
  })
  .catch(err => { 
    console.error(err); 
    alert('Ошибка загрузки расписания.'); 
  });





function mskD(d){return new Date(d.getTime()+6e4*(MSK_OFFSET+d.getTimezoneOffset())).toISOString().slice(0,10);}
function render(){
    let d=new Date(),html='';
    for(let i=0;i<daysShow;i++){
        let k=mskD(d),sd=new Date(d.getTime()+6e4*(MSK_OFFSET+d.getTimezoneOffset()));
        html+=`<div><b>${sd.toLocaleDateString('ru',{weekday:'long',day:'numeric',month:'short'})}</b><br>`;
        for(let h=openHour;h<closeHour;h++){
            let b=BOOKED[k]?.includes(h)?'booked':'';
            html+=`<div class='slot ${b}' data-d='${k}' data-h='${h}'>${h}:00</div>`;
            if((h-openHour+1)%4==0)html+='<br>';
        }
        html+='</div><hr>';d.setDate(d.getDate()+1);
    }
    document.getElementById('calendar').innerHTML=html;
    document.querySelectorAll('.slot:not(.booked)').forEach(e=>e.onclick=()=>choose(e.dataset.d,+e.dataset.h));
}
function free(d,h){return h>=openHour&&h<closeHour&&!BOOKED[d]?.includes(h)}
function choose(d,h){selD=d;selH=h;selL=getInitialL(d,h);upd();}

// пример метода отправки бронирования
function bookSlots() {
  if (!selD || selH === null || selL < 1) {
    alert("Выбери слот для бронирования!");
    return;
  }

  // Telegram данные пользователя (username и имя)
  const username = Telegram.WebApp.initDataUnsafe?.user?.username;
  const customer = Telegram.WebApp.initDataUnsafe?.user?.first_name || username || "unknown";

  fetch('https://drumfitness.ru/api/bookings', {
     method: "POST",
     headers: {
       "Content-Type": "application/json"
     },
     body: JSON.stringify({
        date: selD,
        hours: Array.from({length: selL}, (_, i) => selH + i),
        customer: customer,
        username: username,
        total_price: final_price  // <- Итоговая цена из нашей переменной
     })
  })
  .then(res => res.json())
  .then(res => {
     if(res.status === "OK"){
         alert("✅ Забронировано успешно! Скоро администрация подтвердит заявку.");
         location.reload();
     } else {
         alert("❌ Ошибка при бронировании! Попробуй повторить запрос.");
     }
  })
  .catch(err => {
      console.error(err);
      alert("Ошибка связи с сервером. Повторите чуть позже.");
  });
}


function getInitialL(d,h){
    if(free(d,h+1)&&free(d,h+2))return 3;
    if(free(d,h+1))return 2;
    if((!free(d,h-1)&&!free(d,h+1))||(h==closeHour-1&&!free(d,h-1)))return 1;
    return 0;
}
function canBookOne(d,h){return(!free(d,h-1)&&!free(d,h+1))||(h==closeHour-1&&!free(d,h-1))}
function upd(){
    document.querySelectorAll('.slot').forEach(e=>e.classList.remove('selected'));
    if(selL<1){selD=null;selH=null;selL=0;document.getElementById('summary').innerHTML='Неверный выбор';return;}
    let total=0,full=0,basePrices=[];
    for(let h=selH;h<selH+selL;h++){
        document.querySelector(`.slot[data-d='${selD}'][data-h='${h}']`).classList.add('selected');
        // исправлено тут (теперь явно указано для 1,2,3+ часов)
        let basePrice = selL==1 ? 400 : (selL==2 ? 300 : (h-selH<2 ? 300 : 250));
        basePrices.push(basePrice);
    }
    full=basePrices.reduce((a,b)=>a+b,0);

    basePrices.forEach((hourPrice,i)=>{
        let curHour=selH+i,discount=0;
        if(curHour>=7&&curHour<11)discount=0.3;
        else if(curHour>=11&&curHour<14)discount=0.1;
        total+=hourPrice*(1-discount);
    });
    total=Math.round(total);
    final_price = total; // Записываем итоговую цену в нашу переменную

    document.getElementById('hCount').innerText=selL;
    let discText='';
    if(total<full){
        discText=`<span class="old-price">${full}₽</span><span class="final-price">${total}₽</span>`;
    }else discText=`${full}₽`;
    document.getElementById('summary').innerHTML=`Выбрано ${selD} с ${selH}:00 до ${selH+selL}:00 (${discText})`;
}
document.getElementById('minusHour').onclick=()=>{
    if(selL>3||(selL==3&&free(selD,selH+1))||(selL==2&&canBookOne(selD,selH))){selL--;upd();}
    else alert('Нельзя уменьшить меньше минимума');
};
document.getElementById('plusHour').onclick=()=>{
    if(free(selD,selH+selL)){selL++;upd();}
    else alert('Час занят или конец дня');
};
render();
</script>
</body>
</html>
